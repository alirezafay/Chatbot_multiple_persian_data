<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chat with Your Bot</title>
  <link rel="stylesheet" href="/static/styles.css" />
</head>
<body>
  <div class="blurred-text">Ø´Ø±Ú©Øª ØªÙˆØ³Ø¹Ù‡â€ŒÛŒ Ù‡ØªÙ„â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø±ÛŒØ§ Ø¢Ø³ÛŒØ§</div>

  <div class="chat-container">
    <div class="chat-box">
      <div class="chat-header" id="chatHeader">Ø±Ø¨Ø§Øª Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø´Ø®ØµÛŒâ€ŒØ³Ø§Ø²ÛŒâ€ŒØ´Ø¯Ù‡</div>

      <!-- Profile Selection -->
      <select id="userSelector" onchange="updateProfile()">
        <option value="user_ahmad">Ahmad</option>
        <option value="user_sara">Sara</option>
      </select>

      <div class="chat-messages" id="messages"></div>

      <textarea id="userInput" placeholder="Ø³ÙˆØ§Ù„ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù¾Ø±Ø³ÛŒØ¯..."></textarea>
      <button onclick="sendMessage()">Ø§Ø±Ø³Ø§Ù„</button>
    </div>
  </div>

  <script>
    let chatHistory = [];

    async function updateProfile() {
      const userId = document.getElementById('userSelector').value;
      const chatHeader = document.getElementById('chatHeader');

      chatHeader.textContent = userId === 'user_ahmad'
        ? 'Ú†Øª Ø¨Ø§ Ø§Ø­Ù…Ø¯ - Ù…Ø¯ÛŒØ± Ú©Ø³Ø¨â€ŒÙˆÚ©Ø§Ø±'
        : 'Ú†Øª Ø¨Ø§ Ø³Ø§Ø±Ø§ - Ù…Ù‡Ù†Ø¯Ø³ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ';

      try {
        const response = await fetch('/history', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user_id: userId })
        });

        const data = await response.json();
        chatHistory = data.history || [];
        updateChatDisplay();
      } catch (err) {
        console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ú¯ÙØªÚ¯Ùˆ:', err);
      }
    }

    function formatResponse(text) {
      return text.replace(/\n/g, '<br>');
    }

    async function sendMessage() {
      const input = document.getElementById('userInput');
      const userId = document.getElementById('userSelector').value;
      const question = input.value.trim();

      if (!question) {
        alert("Ù„Ø·ÙØ§Ù‹ Ø³ÙˆØ§Ù„ÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯!");
        return;
      }

      chatHistory.push({ role: 'user', content: question });
      input.value = '';
      updateChatDisplay();

      chatHistory.push({ role: 'bot', content: 'ğŸ¤– Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´...' });
      updateChatDisplay();

      try {
        const response = await fetch('/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query: question, user_id: userId })
        });

        const data = await response.json();
        const botReply = data.reply || "Ù…ØªØ£Ø³ÙÙ…ØŒ Ù…ØªÙˆØ¬Ù‡ Ù†Ø´Ø¯Ù….";

        chatHistory.pop();
        chatHistory.push({ role: 'bot', content: botReply });
        updateChatDisplay();
      } catch (err) {
        console.error('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…:', err);
        chatHistory.push({ role: 'bot', content: "Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±." });
        updateChatDisplay();
      }
    }

    function updateChatDisplay() {
      const messagesDiv = document.getElementById('messages');
      messagesDiv.innerHTML = '';

      chatHistory.forEach(msg => {
        const roleClass = msg.role === 'user' ? 'user-message' : 'bot-message';
        const label = msg.role === 'user' ? 'Ø´Ù…Ø§' : 'Ø±Ø¨Ø§Øª';
        const formatted = formatResponse(msg.content);
        messagesDiv.innerHTML += `<div class="${roleClass}"><strong>${label}:</strong> ${formatted}</div>`;
      });

      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    window.onload = () => {
      updateProfile();
    };
  </script>
</body>
</html>
